<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Test de Piel · BiancaBloomRingana — PRO (v2)</title>
<style>
  :root{
    --rg-green:#6fb28c;
    --rg-dark:#3b7f64;
    --rg-bg:#f2f6f4;
    --card:#ffffff;
    --muted:#9aaea0;
    --accent:#dff2e6;
    --text:#1e1e1e;
    --max-width:980px;
  }
  *{box-sizing:border-box}
  body{
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background:var(--rg-bg);
    color:var(--text);
    margin:0;
    padding:22px;
    -webkit-font-smoothing:antialiased;
  }
  .wrap{max-width:var(--max-width);margin:0 auto;background:var(--card);border-radius:14px;padding:26px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
  header{text-align:center;margin-bottom:12px}
  header h1{margin:0;color:var(--rg-dark);font-size:20px}
  header p{margin:6px 0 0;color:var(--muted);font-size:13px}
  .tagline{color:var(--rg-dark);font-style:italic;margin-top:6px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media(max-width:940px){.grid{grid-template-columns:1fr}}
  .panel{background:#fff;padding:14px;border-radius:12px;border:1px solid #eef5ef}
  .section-title{font-weight:700;color:var(--rg-dark);margin-bottom:8px}
  label{display:block;font-weight:600;margin-top:10px;margin-bottom:6px}
  select,input[type=text],textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e0e7e2;background:#fff;resize:vertical}
  .row{display:flex;gap:10px}
  .small{width:110px}
  .checkboxes label{font-weight:500;padding:6px 0;display:block}
  .btn{display:inline-block;background:var(--rg-green);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;color:var(--rg-dark);border:1px solid var(--rg-dark)}
  .muted{color:var(--muted);font-size:13px}
  .result{margin-top:18px}
  .card{background:var(--accent);padding:12px;border-radius:10px}
  .routine-list, .supl-list{margin:8px 0 0 18px}
  .share{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .share a{display:inline-block;padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #e8efe9;color:var(--rg-dark);text-decoration:none;font-weight:600}
  .preview-img{max-width:100%;border-radius:8px;border:1px solid #e6eee7;margin-top:8px}
  .small-muted{font-size:12px;color:var(--muted)}
  footer{margin-top:18px;font-size:13px;color:var(--muted);text-align:center}
  .note-block{background:#fbfffc;border-left:4px solid var(--rg-green);padding:10px;border-radius:8px;margin-top:10px}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:720px){.two-col{grid-template-columns:1fr}}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#fff;border:1px solid #e6f0ea;margin-right:6px;font-weight:600;color:var(--rg-dark)}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <h1>Test de Piel · BiancaBloomRingana — Profesional</h1>
    <p class="tagline">Ética y excelencia: el cóctel infalible.</p>
    <p class="muted">Informe detallado • Opción foto opcional • Tono: profesional y cercano</p>
  </header>

  <!-- ACCESS GATE -->
  <div id="accessGate" class="panel" role="region" aria-label="Acceso seguro">
    <div class="section-title">Acceso seguro</div>
    <p class="muted">Acceso solo si vienes desde la confirmación de registro Ringana o usas el botón de simulación para pruebas.</p>
    <p><strong>Enlace de registro (tu enlace):</strong></p>
    <input id="registerLink" type="text" value="https://www.ringana.com/es/4577798" />
    <p class="small-muted">Al registrarte, tu página de confirmación debe redirigir a: <code>?registered=true</code></p>
    <div style="margin-top:10px">
      <a id="openReg" class="btn" target="_blank" rel="noopener">Ir al registro</a>
      <button class="btn ghost" onclick="simulateAccess()">Simular registro (pruebas)</button>
    </div>
  </div>

  <div class="grid" id="mainGrid" style="display:none;margin-top:16px">
    <!-- LEFT: FORM -->
    <div>
      <div class="panel">
        <div class="section-title">1 — Diagnóstico inicial (obligatorio)</div>
        <p class="muted">Responde con sinceridad: las preguntas están calibradas para detectar subtipos y riesgos.</p>

        <label for="q1">1. Edad</label>
        <select id="q1">
          <option value="0">Menos de 25</option><option value="1">26–35</option><option value="2">36–45</option><option value="3">46–55</option><option value="4">Más de 55</option>
        </select>

        <label for="q2">2. ¿Tomás el sol con frecuencia?</label>
        <select id="q2"><option value="0">No</option><option value="1">Ocasional</option><option value="2">Frecuente</option></select>

        <label for="q3">3. ¿Trabajas en interiores (horas)?</label>
        <select id="q3"><option value="1">Sí</option><option value="0">No</option></select>

        <label for="q4">4. Sensación de la piel al tacto</label>
        <select id="q4"><option value="0">Ligera / no grasa</option><option value="1">Término medio</option><option value="2">Resequedad</option></select>

        <label for="q5">5. Consumo de alcohol</label>
        <select id="q5"><option value="0">No</option><option value="1">Ocasional</option><option value="2">Regular</option></select>

        <label for="q6">6. ¿Tienes imperfecciones activas (granos/lesiones)?</label>
        <select id="q6"><option value="0">Sí</option><option value="1">No</option></select>

        <label for="q7">7. ¿Observas arrugas visibles?</label>
        <select id="q7"><option value="2">Sí</option><option value="0">No</option></select>

        <label for="q8">8. ¿Vives en ciudad con polución?</label>
        <select id="q8"><option value="1">Sí</option><option value="0">No</option></select>

        <label for="q9">9. Actividad física semanal</label>
        <select id="q9"><option value="0">&gt;1h</option><option value="1">30–60 min</option><option value="2">&lt;30 min</option></select>

        <label for="q10">10. Complexión</label>
        <select id="q10"><option value="2">Bajo peso</option><option value="0">Normal</option><option value="1">Sobrepeso</option></select>

        <label for="q11">11. Exposición a aire acondicionado / calefacción</label>
        <select id="q11"><option value="1">Sí</option><option value="0">No</option></select>

        <label for="q12">12. Alimentación (autoevaluación)</label>
        <select id="q12"><option value="0">Equilibrada</option><option value="1">A veces</option><option value="2">Poco equilibrada</option></select>

        <label for="q13">13. ¿Fumas?</label>
        <select id="q13"><option value="0">No</option><option value="1">&lt;10/día</option><option value="2">≥10/día</option></select>

        <label for="q14">14. Poros visibles</label>
        <select id="q14"><option value="0">Sí</option><option value="1">No</option></select>

        <label for="q15">15. ¿Se irrita con facilidad?</label>
        <select id="q15"><option value="2">Sí</option><option value="0">No</option></select>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">2 — Información complementaria (no puntuable)</div>
        <label for="q16">16. Enfermedades / medicación relevante</label>
        <input id="q16" type="text" placeholder="Ej. rosácea, dermatitis, isotretinoína...">
        <label for="q17">17. Otras notas (sensibilidades, alergias)</label>
        <input id="q17" type="text" placeholder="Ej. piel muy sensible, eczema...">
        <label for="q18">18. Objetivo principal</label>
        <input id="q18" type="text" placeholder="Más luminosidad, menos rojeces...">
        <label for="q19">19. Comentarios extra</label>
        <textarea id="q19" rows="2" placeholder="Algo que debamos saber..."></textarea>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">3 — Personalización avanzada</div>
        <label for="q20">20. Sensibilidad</label>
        <select id="q20"><option value="calm">Muy sensible / reactiva</option><option value="pure">Normal / tolera activos</option></select>

        <label for="q21">21. Prioridad actual</label>
        <select id="q21"><option value="hydro">Hidratación</option><option value="antiage">Antiedad</option><option value="reduce">Reducir imperfecciones</option></select>

        <label for="q22">22. ¿Toleras activos por la noche?</label>
        <select id="q22"><option value="overnight">Sí, activos potentes</option><option value="perfection">No, suaves</option></select>

        <div class="checkboxes" style="margin-top:10px">
          <label><input type="checkbox" class="obj" value="effect"> Firmeza</label>
          <label><input type="checkbox" class="obj" value="glow"> Luminosidad</label>
          <label><input type="checkbox" class="obj" value="repair"> Reducir rojeces</label>
          <label><input type="checkbox" class="obj" value="eye"> Contorno de ojos</label>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">4 — Foto opcional (mejora la precisión)</div>
        <p class="muted">Subir una foto ayuda a afinar observaciones (opcional). La imagen se usa solo para el informe en pantalla y no se almacena ni se envía a servidores.</p>
        <input id="photoInput" type="file" accept="image/*" />
        <div id="photoPreviewWrap" style="display:none">
          <img id="photoPreview" class="preview-img" alt="Previsualización">
          <div class="small-muted">Previsualización (solo para tu informe). No se guarda.</div>
        </div>
      </div>

      <div style="margin-top:12px">
        <button class="btn" onclick="runTest()" id="runBtn">Generar informe profesional</button>
      </div>
    </div>

    <!-- RIGHT: INFO + RESULT -->
    <aside>
      <div class="panel card">
        <div class="section-title">Acceso & pruebas</div>
        <p class="muted">Si estás probando, usa "Simular registro". Para producción, asegúrate de que la confirmación Ringana redirige con <code>?registered=true</code>.</p>
        <div style="margin-top:10px">
          <button class="btn ghost" onclick="resetForm()">Reiniciar formulario</button>
        </div>
      </div>

      <div id="resultPanel" class="panel" style="margin-top:12px;display:none" aria-live="polite">
        <div class="section-title">Informe detallado</div>
        <div id="diagnosis"></div>
        <div id="needs"></div>
        <div id="priority"></div>
        <div id="routine"></div>
        <div id="suplementation"></div>
        <div id="whatToExpect"></div>
        <div id="commonMistakes"></div>
        <div id="photoAnalysis"></div>

        <div class="share" id="shareWrap" style="display:none">
          <a id="mailto" href="#">Enviar por email</a>
          <a id="wa" href="#" target="_blank">Enviar por WhatsApp</a>
          <button class="btn" onclick="downloadPDF()">Descargar informe (PDF)</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title">Notas profesionales</div>
        <p class="muted">Si existen lesiones abiertas, dolor, supuración o el paciente toma medicación (ej. isotretinoína, antibióticos), remitir a dermatólogo antes de cualquier activo.</p>
      </div>
    </aside>
  </div>

  <footer class="muted">Test desarrollado para BiancaBloomRingana — uso profesional y orientativo.</footer>
</div>

<script>
/* ---------- UTILIDADES ---------- */
function qs(id){ return document.getElementById(id); }
function intval(v){ const n = Number.parseInt(String(v).replace(/[^\d-]/g,''),10); return Number.isNaN(n) ? 0 : n; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- ACCESS GATE (local expiry) ---------- */
const REGISTER_KEY = 'ringana_registered_v2';
const REGISTER_TS_KEY = 'ringana_registered_ts_v2';
const REGISTER_TTL_MS = 24 * 3600 * 1000;

function now(){ return Date.now(); }
function setRegistered(){ localStorage.setItem(REGISTER_KEY,'true'); localStorage.setItem(REGISTER_TS_KEY,String(now())); }
function clearRegistered(){ localStorage.removeItem(REGISTER_KEY); localStorage.removeItem(REGISTER_TS_KEY); }
function checkRegistered(){
  const params = new URLSearchParams(location.search);
  if(params.get('registered') === 'true'){ setRegistered(); return true; }
  const flag = localStorage.getItem(REGISTER_KEY) === 'true';
  const ts = Number(localStorage.getItem(REGISTER_TS_KEY) || '0');
  if(flag && ts && (now()-ts) < REGISTER_TTL_MS) return true;
  clearRegistered();
  return false;
}
qs('openReg').href = qs('registerLink').value;
qs('registerLink').addEventListener('input', ()=>{ qs('openReg').href = qs('registerLink').value; });

function simulateAccess(){ setRegistered(); showMain(); }

if(checkRegistered()) showMain(); else qs('accessGate').style.display='block';
function showMain(){ qs('accessGate').style.display='none'; qs('mainGrid').style.display='grid'; }

/* ---------- PHOTO HANDLING (client-only) ---------- */
let _photoDataUrl = null;
qs('photoInput').addEventListener('change', function(ev){
  const f = ev.target.files[0];
  if(!f) { qs('photoPreviewWrap').style.display='none'; _photoDataUrl = null; return; }
  if(f.size > 4 * 1024 * 1024){ alert('La imagen es muy grande (>4MB). Reduce tamaño y vuelve a subir.'); return; }
  const reader = new FileReader();
  reader.onload = function(e){
    _photoDataUrl = e.target.result;
    qs('photoPreview').src = _photoDataUrl;
    qs('photoPreviewWrap').style.display = 'block';
  };
  reader.readAsDataURL(f);
});

/* ---------- LÓGICA DE DIAGNÓSTICO (más precisa) ---------- */
function getScores(){
  const s = {};
  for(let i=1;i<=15;i++){
    const el = qs('q'+i);
    if(!el) throw new Error('Falta pregunta q'+i);
    s['q'+i] = intval(el.value);
  }
  s.q16 = (qs('q16').value||'').trim();
  s.q17 = (qs('q17').value||'').trim();
  s.q18 = (qs('q18').value||'').trim();
  s.q19 = (qs('q19').value||'').trim();
  s.q20 = qs('q20').value;
  s.q21 = qs('q21').value;
  s.q22 = qs('q22').value;
  s.objs = Array.from(document.querySelectorAll('.obj:checked')).map(x=>x.value);
  return s;
}

function computeTotal(scores){
  let total = 0;
  for(let i=1;i<=15;i++) total += intval(scores['q'+i]);
  return total;
}

function deriveSkinType(total, scores){
  // Afinamos con thresholds y algunos pesos
  // total bajo -> más grasa, total alto -> más seco
  if(total <= 9) return 'Piel Grasa';
  if(total <= 19) return 'Piel Mixta';
  return 'Piel Seca';
}

function analyseSubtypes(scores, tipo){
  const notes = [];
  const flags = {};
  // Deshidratación: preferencia crema rica o aire/actividad baja o alimentación mala
  flags.likelyDehydrated = (scores.q11 === 1 || scores.q12 >= 1 || scores.q9 === 2);
  if(flags.likelyDehydrated) notes.push('Tendencia a DESHIDRATACIÓN (hidratar interna y externamente).');

  // Asfixiada: poros + impurezas + preferencia ligera + signos de congestión
  flags.impurezas = scores.q6 === 0;
  flags.poros = scores.q14 === 0;
  flags.prefLigera = scores.q4 === 0;
  flags.asfixiada = (tipo !== 'Piel Seca') && flags.impurezas && flags.poros && flags.prefLigera && flags.likelyDehydrated;
  if(flags.asfixiada) notes.push('Piel ASFIXIADA: zonas con poros obstruidos y falta de hidratación efectiva.');

  // Inflamación activa (si hay imperfecciones y sensibilidad alta)
  flags.activeLesions = flags.impurezas && scores.q15 === 2;
  if(flags.activeLesions) notes.push('Signos de INFLAMACIÓN/lesiones activas (tratar con calma y priorizar reparación).');

  // Madura
  flags.isMature = (scores.q1 >= 3) || scores.q7 >= 2;
  if(flags.isMature) notes.push('Piel MÁTURA (enfocar antiedad y reparación).');

  // Reactiva
  flags.reactive = (scores.q20 === 'calm') || scores.q16.length>0 || scores.q15 === 2;
  if(flags.reactive) notes.push('Piel REACTIVA / sensible (evitar irritantes y progresar despacio).');

  // Riesgo de cicatriz / marcas si hay lesiones abiertas
  flags.scarringRisk = flags.activeLesions && (scores.q13 > 0 || scores.q12 >= 1);
  if(flags.scarringRisk) notes.push('Riesgo de formación de marcas/cicatrices: priorizar manejo de inflamación.');

  return { notes, flags };
}

/* ---------- Rutina avanzada (explicada) ---------- */
function buildRoutine(tipo, flags, scores, objs){
  const rutina = [];
  // Limpieza
  rutina.push({title:'Limpieza (mañana y noche)', text:'FRESH Cleanser — limpieza suave, sin frotar. Limpiar con las yemas y enjuagar con agua templada.'});

  // Tónico
  if(flags.reactive || tipo === 'Piel Seca'){
    rutina.push({title:'Tónico', text:'Tonic Calm — tónico suavizante que reduce rojeces y refuerza la barrera. Aplicar con las manos.'});
  } else {
    rutina.push({title:'Tónico', text:'Tonic Pure - usar en zona T si hay tendencia a brillos; evitar fricción en mejillas.'});
  }

  // Sérums
  if(flags.asfixiada){
    rutina.push({title:'Hidratación y renovación', text:'Hydro Serum + exfoliante químico suave semanal (BHA/AHA suave) solo si la piel no está lesionada. Priorizar Hydro Serum para restaurar barrera.'});
  } else {
    rutina.push({title:'Hidratación', text:'Hydro Serum — 1–2 pumps, aplicar en piel limpia con movimientos suaves.'});
  }

  // ADDS y boosters
  if(scores.q21 === 'antiage' || flags.isMature){
    rutina.push({title:'Antiedad (mañana)', text:'ADDS Effect + Vitamina C por la mañana si tolera — mejora textura y firmeza.'});
  }
  if(scores.q21 === 'hydro' || flags.likelyDehydrated){
    rutina.push({title:'Potenciador de hidratación', text:'ADDS Glow — usar como booster 1–3 veces/semana o según necesidad.'});
  }

  // Cremas según tipo
  if(tipo === 'Piel Grasa') rutina.push({title:'Hidratación final', text:'Cream Light — textura ligera, no comedogénica.'});
  if(tipo === 'Piel Mixta') rutina.push({title:'Hidratación final', text:'Cream Medium — equilibra zonas T y mejillas.'});
  if(tipo === 'Piel Seca') rutina.push({title:'Hidratación final', text:'Cream Rich — aplicar con piel húmeda tras serum para sellar hidratación.'});

  // Noche: activos según tolerancia
  if(scores.q22 === 'overnight'){
    rutina.push({title:'Noche (activos)', text:'Overnight Repair — iniciar con 1 vez/semana y aumentar si no hay reacción.'});
  } else {
    rutina.push({title:'Noche (suave)', text:'Skin Perfection — fórmula reparadora suave para usar regularmente.'});
  }

  // Extras por objetivos
  if(objs.includes('glow')) rutina.push({title:'Luminosidad', text:'ADDS Glow extra: 1–2 veces/semana como booster o por la mañana si tolera.'});
  if(objs.includes('effect')) rutina.push({title:'Firmeza', text:'ADDS Effect (sérum reafirmante) — 2–3 veces/semana.'});
  if(objs.includes('repair')) rutina.push({title:'Calma y repara', text:'ADDS Repair — aplicar en áreas con rojeces según tolerancia.'});
  if(objs.includes('eye')) rutina.push({title:'Contorno de ojos', text:'Eye Serum — dos toques suaves por la mañana y noche.'});

  // Practical
  const practical = [];
  practical.push('Protector solar SPF30+ diario: imprescindible (si usa activos, atención a protección).');
  if(scores.q2 >= 1) practical.push('Evitar exposiciones largas sin protección.');
  if(scores.q11 === 1) practical.push('Aportar hidratación extra en ambientes con climatización.');

  return { rutina, practical };
}

/* ---------- Suplementación razonada ---------- */
function buildSupplements(tipo, flags, scores, objs){
  const suples = [];
  function pushS(s){ if(s && !suples.includes(s) && suples.length < 3) suples.push(s); }
  if(tipo === 'Piel Grasa') pushS('CAPS Skin');
  if(tipo === 'Piel Mixta') pushS('CAPS Antiox');
  if(tipo === 'Piel Seca') pushS('CAPS Hyaluron');
  if(flags.reactive) pushS('CAPS Protect');
  if(flags.isMature || scores.q21 === 'antiage') pushS('CAPS Omega 3');
  if(scores.q2 >= 1 || scores.q8 === 1) pushS('CAPS Antiox');
  if(scores.q11 === 1) pushS('CAPS Hyaluron');
  if(scores.q12 >= 1 || scores.q5 >= 1) pushS('PACK Cleansing');
  if(scores.q13 >= 1) pushS('CAPS Omega 3');
  if(scores.q9 === 2) pushS('PACK Energy');
  if(objs.includes('repair')) pushS('CAPS Protect');
  if(objs.includes('glow')) pushS('CAPS Antiox');
  if(objs.includes('effect')) pushS('CAPS Antiox');
  if(!suples.length) pushS('CAPS Antiox');

  const desc = {
    "CAPS Skin":"Apoya equilibrio del microbioma cutáneo y reduce impurezas.",
    "CAPS Hyaluron":"Hialurónico oral para hidratación y elasticidad interna.",
    "CAPS Protect":"Refuerza barrera y reduce reactividad (antiinflamatorio leve).",
    "CAPS Antiox":"Antioxidantes frente a sol, contaminación y estrés.",
    "CAPS Omega 3":"Ácidos grasos para inflamación, hidratación y circulación.",
    "PACK Cleansing":"Apoya función hepática y limpieza interna (detox suave).",
    "PACK Energy":"Soporte energético para piel cansada."
  };
  return { suples, desc };
}

/* ---------- Foto-análisis (observaciones seguras) ---------- */
function analysePhoto(scores){
  if(!_photoDataUrl) return null;
  // No hacemos procesamiento de imagen (por seguridad y por ser estático).
  // En su lugar, ofrecemos observaciones útiles y seguras:
  const obs = [];
  if(scores.q6 === 0) obs.push('Se observan imperfecciones: la foto ayuda a confirmar inflamación y distribución.');
  if(scores.q15 === 2) obs.push('Sensibilidad reportada: tener en cuenta al introducir activos.');
  if(scores.q14 === 0) obs.push('Poros visibles; la imagen permite ver congestión en zona T.');
  // Damos indicaciones generales basadas en la foto + respuestas:
  obs.push('Observaciones: si la imagen muestra heridas abiertas, priorizar reparación y acudir a profesional si hay supuración.');
  return obs;
}

/* ---------- RENDER INFORME (tono B: profesional + cálido) ---------- */
function renderReport(output){
  qs('resultPanel').style.display='block';
  qs('diagnosis').innerHTML = `<div><strong>Diagnóstico (resumen):</strong> ${escapeHtml(output.tipoBase)}</div>
    <div class="muted" style="margin-top:6px">${output.subtypeNotes.length ? escapeHtml(output.subtypeNotes.join(' • ')) : 'Sin subtipo destacado'}</div>
    <div style="margin-top:8px"><strong>Puntuación:</strong> ${output.total} puntos</div>`;

  // Needs
  qs('needs').innerHTML = `<div style="margin-top:10px"><strong>Necesidades detectadas:</strong>
    <ul>${output.needs.map(n=>`<li>${escapeHtml(n)}</li>`).join('')}</ul></div>`;

  // Priority
  qs('priority').innerHTML = `<div style="margin-top:10px"><strong>Prioridad absoluta:</strong>
    <div class="note-block">${escapeHtml(output.priority)}</div></div>`;

  // Routine (detailed)
  qs('routine').innerHTML = `<div style="margin-top:10px"><strong>Rutina personalizada (explicada)</strong>
    <div class="small-muted" style="margin-top:6px">Sigue este plan durante 30 días; ajusta si notas irritación.</div>
    <div style="margin-top:8px">
      ${output.rutina.rutina.map(r=>`<div style="margin-bottom:8px"><strong>${escapeHtml(r.title)}</strong><div class="muted" style="margin-top:4px">${escapeHtml(r.text)}</div></div>`).join('')}
    </div>
    <div style="margin-top:8px"><strong>Consejos prácticos:</strong><ul>${output.rutina.practical.map(p=>`<li>${escapeHtml(p)}</li>`).join('')}</ul></div>
    </div>`;

  // Supplements
  qs('suplementation').innerHTML = `<div style="margin-top:10px"><strong>Suplementación sugerida (máx 3):</strong>
    <ul>${output.suples.map(s=>`<li><strong>${escapeHtml(s)}</strong> — ${escapeHtml(output.suplDesc[s]||'')}</li>`).join('')}</ul>
    <div class="small-muted">Nota: consulta siempre con profesional de salud en embarazo, lactancia o medicación.</div>
    </div>`;

  // What to expect
  qs('whatToExpect').innerHTML = `<div style="margin-top:10px"><strong>Qué esperar en 30 días</strong>
    <ul>${output.expect30.map(e=>`<li>${escapeHtml(e)}</li>`).join('')}</ul></div>`;

  // Common mistakes
  qs('commonMistakes').innerHTML = `<div style="margin-top:10px"><strong>Errores comunes que debes evitar</strong>
    <ul>${output.commonMistakes.map(e=>`<li>${escapeHtml(e)}</li>`).join('')}</ul></div>`;

  // Photo analysis (if any)
  if(output.photoNotes){
    qs('photoAnalysis').innerHTML = `<div style="margin-top:10px"><strong>Foto (observaciones)</strong>
      <div class="muted" style="margin-top:6px">${output.photoNotes.map(p=>escapeHtml(p)).join(' • ')}</div>
      <div style="margin-top:8px"><img src="${_photoDataUrl}" class="preview-img" alt="Foto del cliente (solo informe)"></div>
    </div>`;
  } else {
    qs('photoAnalysis').innerHTML = '';
  }

  // Share links
  const subj = encodeURIComponent('Mi informe de piel · BiancaBloomRingana');
  const body = encodeURIComponent(`Hola,%0A%0AMi diagnóstico ha sido: ${output.tipoBase}.%0ASubtipos: ${output.subtypeNotes.join(', ') || 'Ninguno'}.%0A%0ARutina recomendada:%0A- ${output.rutina.rutina.map(r=>r.title).join('%0A- ')}%0A%0ASuplementación sugerida:%0A- ${output.suples.join('%0A- ')}%0A%0AUn saludo.`);
  qs('mailto').href = `mailto:?subject=${subj}&body=${body}`;
  const waMsg = encodeURIComponent(`Diagnóstico: ${output.tipoBase}. Rutina: ${output.rutina.rutina.map(r=>r.title).slice(0,6).join('; ')}.`);
  qs('wa').href = `https://wa.me/?text=${waMsg}`;
  qs('shareWrap').style.display = 'flex';

  // store last result for PDF
  window._lastResultV2 = output;
  qs('resultPanel').scrollIntoView({behavior:'smooth'});
}

/* ---------- MAIN ENTRY: runTest ---------- */
function runTest(){
  try{
    const scores = getScores();
    const total = computeTotal(scores);
    const tipoBase = deriveSkinType(total, scores);
    const sub = analyseSubtypes(scores, tipoBase);
    const rutina = buildRoutine(tipoBase, sub.flags, scores, scores.objs);
    const sups = buildSupplements(tipoBase, sub.flags, scores, scores.objs);

    // Needs and priority
    const needs = [];
    if(sub.flags.likelyDehydrated) needs.push('Aumento de hidratación (externa e interna).');
    if(sub.flags.asfixiada) needs.push('Descongestionar y regular poros sin resecar.');
    if(sub.flags.activeLesions) needs.push('Control de inflamación y reparación de barrera.');
    if(sub.flags.reactive) needs.push('Protocolos suaves y progresivos para tolerancia.');
    if(sub.flags.isMature) needs.push('Tratamientos antiedad y reparación de la matriz dérmica.');

    // Priority (el item más urgente)
    let priority = 'Mejorar la barrera cutánea y reducir inflamación activa.';
    if(sub.flags.activeLesions) priority = 'Prioridad: controlar inflamación y evitar cicatrización.';
    else if(sub.flags.asfixiada) priority = 'Prioridad: descongestión y restauración de hidratación profunda.';

    // What to expect en 30 días (realista)
    const expect30 = [
      'Mejor confort y menos tirantez',
      'Reducción gradual de rojeces y brotes (si se siguen indicaciones)',
      'Mejora en la textura y menor congestión',
      'La barrera cutánea mostrará signos de reparación (menos descamación)'
    ];

    // Common mistakes
    const commonMistakes = [
      'Exfoliar enérgicamente cuando existe inflamación o heridas.',
      'Usar aceites o fórmulas oclusivas sobre zonas con lesiones abiertas.',
      'Introducir varios activos potentes a la vez (e.g., Vit C + retinoides).',
      'Tocar o apretar lesiones: aumentan riesgo de cicatriz.'
    ];

    // Photo analysis safe
    const photoNotes = analysePhoto(scores);

    const output = {
      tipoBase,
      subtypeNotes: sub.notes,
      total,
      needs,
      priority,
      rutina,
      suples: sups.suples,
      suplDesc: sups.desc,
      expect30,
      commonMistakes,
      photoNotes
    };

    renderReport(output);
  } catch(e){
    console.error(e);
    alert('Error generando el informe: ' + (e.message || e));
  }
}

/* ---------- RESET ---------- */
function resetForm(){
  const selects = document.querySelectorAll('select');
  selects.forEach(s=>s.selectedIndex = 0);
  const inputs = document.querySelectorAll('input[type="text"], textarea');
  inputs.forEach(i=>i.value = '');
  const checks = document.querySelectorAll('.obj');
  checks.forEach(c=>c.checked = false);
  qs('photoInput').value = '';
  qs('photoPreviewWrap').style.display='none';
  _photoDataUrl = null;
  qs('resultPanel').style.display='none';
  clearRegistered();
}

/* ---------- PDF generation (SIN FOTO por privacidad) ---------- */
function downloadPDF(){
  const r = window._lastResultV2;
  if(!r) return alert('Primero genera el informe.');
  const popup = window.open('','_blank','width=900,height=700');
  const html = `
    <html><head><title>Informe de Piel · BiancaBloomRingana</title>
    <meta charset="utf-8">
    <style>
      body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#222;background:#fff}
      h1{color:${getComputedStyle(document.documentElement).getPropertyValue('--rg-dark')||'#264'};}
      .box{border-radius:8px;padding:12px;background:#f6fbf7;border:1px solid #e6f0ea}
      ul{line-height:1.45}
      .muted{color:#66786e;font-size:13px}
      .section{margin-top:12px}
    </style>
    </head><body>
    <h1>Informe de Piel · BiancaBloomRingana</h1>
    <p class="muted">Ética y excelencia: el cóctel infalible.</p>
    <div class="box">
      <p><strong>Tipo:</strong> ${escapeHtml(r.tipoBase)}</p>
      <p class="muted">${r.subtypeNotes.length? escapeHtml(r.subtypeNotes.join(' • ')) : 'Sin subtipo detectado'}</p>
      <p><strong>Puntuación:</strong> ${r.total}</p>
      <div class="section"><strong>Necesidades:</strong><ul>${r.needs.map(n=>`<li>${escapeHtml(n)}</li>`).join('')}</ul></div>
      <div class="section"><strong>Prioridad:</strong><p>${escapeHtml(r.priority)}</p></div>
      <div class="section"><strong>Rutina (resumen):</strong><ul>${r.rutina.rutina.map(x=>`<li>${escapeHtml(x.title)} — ${escapeHtml(x.text)}</li>`).join('')}</ul></div>
      <div class="section"><strong>Suplementación sugerida:</strong><ul>${r.suples.map(s=>`<li>${escapeHtml(s)} — ${escapeHtml(r.suplDesc[s]||'')}</li>`).join('')}</ul></div>
      <div class="section"><strong>Qué esperar en 30 días:</strong><ul>${r.expect30.map(e=>`<li>${escapeHtml(e)}</li>`).join('')}</ul></div>
      <div class="section muted"><strong>Nota:</strong> la foto que has subido no se incluye en este PDF por privacidad.</div>
    </div>
    <script>window.print()</script>
    </body></html>
  `;
  popup.document.open();
  popup.document.write(html);
  popup.document.close();
}

/* expose for debug */
window.runTest = runTest;
window.resetForm = resetForm;
window.simulateAccess = simulateAccess;
window.downloadPDF = downloadPDF;

</script>
</body>
</html>
