<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Test de Piel · BiancaBloomRingana — Profesional</title>
<style>
  :root{
    --bg:#f6f7f5;
    --card:#fff;
    --accent-green:#5f9b72;
    --accent-dark:#2f5f46;
    --accent-gold:#c9a84a;
    --muted:#7e8b82;
    --soft-border:#e8efe8;
    --text:#233;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Helvetica Neue", Arial, sans-serif;background:var(--bg);color:var(--text);margin:0;padding:28px;}
  .wrap{max-width:1100px;margin:0 auto;background:var(--card);border-radius:16px;padding:30px;box-shadow:0 18px 60px rgba(30,45,30,0.08)}
  header{display:flex;align-items:center;gap:18px;justify-content:center;flex-direction:column;text-align:center}
  header h1{margin:0;color:var(--accent-dark);font-size:30px}
  header p{margin:4px 0 0;color:var(--muted);font-style:italic}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-top:18px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--card);border:1px solid var(--soft-border);padding:18px;border-radius:12px}
  label{display:block;font-weight:700;margin-top:12px;margin-bottom:6px}
  select,input[type=text],input[type=file],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eee6;background:#fff}
  .btn{background:var(--accent-green);color:#fff;padding:12px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--accent-dark);color:var(--accent-dark)}
  .muted{color:var(--muted);font-size:13px}
  .section-title{font-weight:800;color:var(--accent-dark);margin-bottom:8px}
  .box{background:linear-gradient(180deg,#fbfff8, #f7fbf2);padding:12px;border-radius:10px;border:1px solid #eef5ee}
  .result-card{background:linear-gradient(180deg,#fff,#fbfffb);border-left:6px solid var(--accent-gold);padding:14px;border-radius:8px}
  .share{display:flex;gap:8px;margin-top:10px}
  .share a{display:inline-block;padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #f0f2f0;color:var(--accent-dark);text-decoration:none;font-weight:700}
  .small{width:110px}
  .preview{max-width:100%;border-radius:8px;margin-top:8px;border:1px solid #e6efe6}
  ul{line-height:1.5;margin:8px 0}
  footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  .note{font-size:13px;color:#8b978c;margin-top:8px}
  .danger{color:#882b2b;font-weight:700}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <h1>Test de Piel · BiancaBloomRingana — Profesional</h1>
    <p>Ética y excelencia: el cóctel infalible.</p>
    <div class="muted">Informe dermatológico • Foto opcional • Descarga PDF profesional</div>
  </header>

  <!-- Access gate -->
  <div id="accessGate" class="panel" style="margin-top:18px">
    <div class="section-title">Acceso seguro</div>
    <p class="muted">Para proteger la consultoría avanzada, el test solo se desbloquea si vienes desde la confirmación de registro Ringana (<code>?registered=true</code>) o pulsas el botón de simulación para pruebas.</p>

    <label>Tu enlace de registro (tu enlace personal Ringana)</label>
    <input id="registerLink" value="https://www.ringana.com/es/4577798" />

    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn" id="openReg" onclick="openReg()">Ir al registro</button>
      <button class="btn ghost" onclick="simulateAccess()">Simular registro (pruebas)</button>
    </div>

    <p class="note">Sustituye el enlace por tu enlace personal. Tras registrarse, la confirmación debe redirigir con <code>?registered=true</code> para permitir el acceso real.</p>
  </div>

  <!-- Main content -->
  <div id="mainGrid" class="grid" style="display:none">
    <div>
      <div class="panel">
        <div class="section-title">1 — Diagnóstico inicial (preguntas puntuables)</div>

        <!-- 1..15 preguntas detalladas (cada opción con valor) -->
        <label>1. Rango de edad</label>
        <select id="q1">
          <option value="0">Menos de 25</option>
          <option value="1">26–35</option>
          <option value="2">36–45</option>
          <option value="3">46–55</option>
          <option value="4">Más de 55</option>
        </select>

        <label>2. ¿Tomas el sol sin protección frecuentemente?</label>
        <select id="q2">
          <option value="0">Nunca</option>
          <option value="1">Ocasionalmente</option>
          <option value="2">A menudo</option>
        </select>

        <label>3. ¿Trabajas muchas horas en interiores (AC/Calefacción)?</label>
        <select id="q3"><option value="1">Sí</option><option value="0">No</option></select>

        <label>4. Preferencia de textura</label>
        <select id="q4">
          <option value="0">Ligera (no grasa)</option>
          <option value="1">Confort</option>
          <option value="2">Protectora / rica</option>
        </select>

        <label>5. Consumo de alcohol</label>
        <select id="q5"><option value="0">No</option><option value="1">Ocasional</option><option value="2">Regular</option></select>

        <label>6. ¿Tienes impurezas (granos / puntos negros)?</label>
        <select id="q6"><option value="0">Sí</option><option value="1">No</option></select>

        <label>7. ¿Arrugas visibles?</label>
        <select id="q7"><option value="2">Sí</option><option value="0">No</option></select>

        <label>8. ¿Vives en ciudad con contaminación?</label>
        <select id="q8"><option value="1">Sí</option><option value="0">No</option></select>

        <label>9. Ejercicio semanal</label>
        <select id="q9"><option value="0">>1h</option><option value="1">30–60min</option><option value="2">&lt;30min</option></select>

        <label>10. Complexión</label>
        <select id="q10"><option value="2">Bajo peso</option><option value="0">Normal</option><option value="1">Sobrepeso</option></select>

        <label>11. Uso de climatización (AC/calefacción) intensa</label>
        <select id="q11"><option value="1">Sí</option><option value="0">No</option></select>

        <label>12. ¿Cuida alimentación (frutas/verduras/agua)?</label>
        <select id="q12"><option value="0">Sí</option><option value="1">A veces</option><option value="2">No</option></select>

        <label>13. Fumas</label>
        <select id="q13"><option value="0">No</option><option value="1">&lt;10/día</option><option value="2">≥10/día</option></select>

        <label>14. Poros visibles</label>
        <select id="q14"><option value="0">Sí</option><option value="1">No</option></select>

        <label>15. ¿Se irrita tu piel con facilidad?</label>
        <select id="q15"><option value="2">Sí</option><option value="0">No</option></select>

        <!-- Información adicional no puntuable -->
        <div class="section-title" style="margin-top:18px">2 — Información adicional (no puntuable)</div>
        <label>16. Enfermedades / medicación relevante</label>
        <input id="q16" type="text" placeholder="Ej. rosácea, acné severo, medicación..." />

        <label>17. Características especiales</label>
        <input id="q17" type="text" placeholder="Ej. piel muy sensible, eczema..." />

        <label>18. Objetivo principal</label>
        <input id="q18" type="text" placeholder="Ej. más luminosidad, menos arrugas..." />

        <label>19. Notas</label>
        <input id="q19" type="text" placeholder="Algo que quieras destacar" />

        <!-- Personalización avanzada -->
        <div class="section-title" style="margin-top:18px">3 — Personalización avanzada</div>
        <label>20. Sensibilidad / preferencia</label>
        <select id="q20"><option value="calm">Muy sensible / reactiva</option><option value="pure">Normal / impurezas</option></select>

        <label>21. Prioridad ahora</label>
        <select id="q21"><option value="hydro">Hidratación</option><option value="antiage">Antiedad</option><option value="clarify">Regular poros / impurezas</option></select>

        <label>22. ¿Toleras activos por la noche (retinoides, AHA/BHA)?</label>
        <select id="q22"><option value="overnight">Sí — puedo usar activos potentes</option><option value="perfection">No — prefiero suaves</option></select>

        <div style="margin-top:12px" class="muted">Objetivos secundarios (marca los que quieras)</div>
        <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
          <label><input type="checkbox" class="obj" value="effect"> Reafirmar / reducir arrugas</label>
          <label><input type="checkbox" class="obj" value="glow"> Más luminosidad</label>
          <label><input type="checkbox" class="obj" value="repair"> Calmar rojeces</label>
          <label><input type="checkbox" class="obj" value="eye"> Mejor contorno de ojos</label>
        </div>

        <!-- Foto -->
        <label style="margin-top:16px">Foto opcional (ayuda a precisar el diagnóstico)</label>
        <input id="fotoInput" type="file" accept="image/*" />
        <img id="fotoPreview" class="preview" style="display:none" alt="Previsualización" />

        <div style="margin-top:12px">
          <button class="btn" onclick="runTest()">Obtener diagnóstico y rutina</button>
          <button class="btn ghost" onclick="resetForm()">Reiniciar formulario</button>
        </div>

        <p class="note">Nota: las recomendaciones son orientativas. Consulta en embarazo, lactancia o si tomas medicación.</p>
      </div>

      <!-- Result panel -->
      <div class="panel" style="margin-top:14px" id="resultPanel" hidden>
        <div class="section-title">Informe dermatológico profesional</div>
        <div id="diagnosis"></div>
        <div id="routine"></div>
        <div id="supplements"></div>
        <div id="whatToExpect"></div>
        <div style="margin-top:12px" class="muted">Comparte o descarga tu informe:</div>
        <div class="share" id="shareWrap" style="display:none">
          <a id="mailto" href="#">Enviar por email</a>
          <a id="wa" href="#" target="_blank">Enviar por WhatsApp</a>
        </div>
        <div style="margin-top:12px">
          <button class="btn" onclick="downloadPDF()">Descargar informe (PDF)</button>
        </div>
      </div>
    </div>

    <aside>
      <div class="panel box">
        <div class="section-title">Acceso & notas</div>
        <p class="muted">Si vienes desde la página de confirmación tras el alta Ringana, serás redirigida con <code>?registered=true</code> y verás el test sin pasos extra. Para pruebas, usa "Simular registro".</p>
        <div style="margin-top:10px">
          <button class="btn ghost" onclick="copyRegisterLink()">Copiar enlace de registro</button>
        </div>
        <div style="margin-top:12px" class="note"><strong>Seguridad:</strong> Evita combinar suplementos sin supervisión médica en embarazo o con medicación. Las dosis son orientativas.</div>
      </div>

      <div class="panel" style="margin-top:14px">
        <div class="section-title">Cómo interpretamos esto</div>
        <p class="muted">Nuestro algoritmo combina puntuaciones, objetivos y signos visibles (si subes foto) para proponer una rutina priorizada y una selección de suplementos (máx. 3).</p>
      </div>
    </aside>
  </div>

  <footer>Test desarrollado para <strong>BiancaBloomRingana</strong> — uso profesional y orientativo.</footer>
</div>

<script>
/* -------------------- Access gate logic -------------------- */
const params = new URLSearchParams(location.search);
const isRegistered = params.get('registered') === 'true' || localStorage.getItem('ringana_registered') === 'true';

const registerInput = document.getElementById('registerLink');
document.getElementById('openReg').addEventListener('click', openReg);

function openReg(){
  const url = (registerInput && registerInput.value) ? registerInput.value.trim() : '';
  if(!url){ alert('Introduce tu enlace de registro en el campo.'); return; }
  window.open(url,'_blank');
}

function simulateAccess(){
  localStorage.setItem('ringana_registered','true');
  showMain();
}

function showMain(){
  document.getElementById('accessGate').style.display = 'none';
  document.getElementById('mainGrid').style.display = 'grid';
}

if(isRegistered) showMain();

/* -------------------- Helpers -------------------- */
function intval(v){ const n = Number.parseInt(String(v).replace(/[^\d-]/g,''),10); return Number.isNaN(n)?0:n; }
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* -------------------- Image preview -------------------- */
const fotoInput = document.getElementById('fotoInput');
const fotoPreview = document.getElementById('fotoPreview');
let uploadedPhotoData = null;
fotoInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) { fotoPreview.style.display='none'; uploadedPhotoData = null; return; }
  const reader = new FileReader();
  reader.onload = () => { uploadedPhotoData = reader.result; fotoPreview.src = uploadedPhotoData; fotoPreview.style.display='block'; }
  reader.readAsDataURL(f);
});

/* -------------------- Core logic -------------------- */
function runTest(){
  // ensure essential elements
  for(let i=1;i<=15;i++){
    if(!document.getElementById('q'+i)){ alert('Falta la pregunta ' + i); return; }
  }

  // gather values
  const answers = {};
  for(let i=1;i<=15;i++) answers['q'+i] = intval(document.getElementById('q'+i).value);
  const q1 = intval(document.getElementById('q1').value);
  const q2 = intval(document.getElementById('q2').value);
  const q6 = intval(document.getElementById('q6').value);
  const q7 = intval(document.getElementById('q7').value);
  const q11 = intval(document.getElementById('q11').value);
  const q12 = intval(document.getElementById('q12').value);
  const q13 = intval(document.getElementById('q13').value);
  const q9 = intval(document.getElementById('q9').value);
  const q14 = intval(document.getElementById('q14').value);
  const q20 = document.getElementById('q20').value;
  const prio = document.getElementById('q21').value;
  const night = document.getElementById('q22').value;
  const objs = Array.from(document.querySelectorAll('.obj:checked')).map(x=>x.value);
  const hasCondition = (document.getElementById('q16').value || '').trim().length > 0;
  const reactiveFlag = q15 = intval(document.getElementById('q15').value);

  // compute base score (digit-by-digit safety)
  let total = 0;
  for(let i=1;i<=15;i++){ total = total + intval(document.getElementById('q'+i).value); }

  // Base type logic (tuned)
  // Lower totals => more oil-prone (grasa), higher totals => seca
  let tipoBase = total <= 12 ? 'Piel Grasa' : (total <= 24 ? 'Piel Mixta' : 'Piel Seca');

  // subtypes
  const likelyDehydrated = (q11===1 || q12>=1 || q9===2) && (tipoBase !== 'Piel Seca' ? true : true);
  const asfixiada = (tipoBase === 'Piel Grasa' || tipoBase === 'Piel Mixta') && q6===0 && q14===0 && likelyDehydrated;
  const isMature = (q1 >= 3) || q7>=2;
  const reactive = (q20 === 'calm') || hasCondition || reactiveFlag === 2;

  const subtypeNotes = [];
  if(likelyDehydrated) subtypeNotes.push('Tendencia a DESHIDRATACIÓN (hidratación interna + externa)');
  if(asfixiada) subtypeNotes.push('Piel ASFIXIADA: grasa + poros obstruidos + deshidratada');
  if(isMature) subtypeNotes.push('Piel MÁTURA (prioridad antiedad)');
  if(reactive) subtypeNotes.push('Piel REACTIVA / sensible (evitar irritantes)');

  // -------------------- Routine decision rules --------------------
  // Base products mapping to Ringana-like product names (example names)
  const products = {
    cleanser: 'FRESH Cleanser',
    tonic_calm: 'Tonic Calm',
    tonic_pure: 'Tonic Pure',
    hydro_serum: 'FRESH Hydro Serum',
    cream_light: 'FRESH Cream Light',
    cream_medium: 'FRESH Cream Medium',
    cream_rich: 'FRESH Cream Rich',
    overnight_repair: 'Overnight Repair',
    skin_perfection: 'Skin Perfection (noche suave)',
    adds_effect: 'ADDS Effect',
    adds_glow: 'ADDS Glow',
    adds_repair: 'ADDS Repair',
    eye_serum: 'Eye Serum'
  };

  const rutina = [];
  rutina.push(`${products.cleanser} — limpieza suave (mañana y noche)`);

  // tonico
  if(tipoBase === 'Piel Grasa'){
    if(reactive) rutina.push(`${products.tonic_calm} — tónico equilibrante para grasa sensible`);
    else if(asfixiada) rutina.push(`${products.tonic_pure} — priorizar zona T y poros; usar con precaución`);
    else rutina.push(`${products.tonic_pure} — controla sebo y poros`);
  } else if(tipoBase === 'Piel Mixta'){
    if(reactive) rutina.push(`${products.tonic_calm} — suaviza mejillas y calma`);
    else rutina.push(`${products.tonic_pure} — aplicar en zona T según tolerancia`);
  } else {
    rutina.push(`${products.tonic_calm} — tónico hidratante y calmante`);
  }

  // serum
  if(asfixiada){
    rutina.push(`${products.hydro_serum} + exfoliante químico suave semanal (BHA/AHA suave) — mejora renovación sin resecar`);
  } else {
    rutina.push(`${products.hydro_serum} — hidratación de barrera`);
  }

  // cremas
  if(tipoBase === 'Piel Grasa') rutina.push(`${products.cream_light} — hidratación ligera, no comedogénica`);
  if(tipoBase === 'Piel Mixta') rutina.push(`${products.cream_medium} — equilibrio para zonas mixtas`);
  if(tipoBase === 'Piel Seca') rutina.push(`${products.cream_rich} — nutrición intensa (aplicar con piel húmeda)`);

  // prioridad antiage/hydro
  if(prio === 'antiage' || isMature){ rutina.push(`${products.adds_effect} — para firmeza y arrugas (mañana si tolera)`); }
  if(prio === 'hydro' || likelyDehydrated){ rutina.push(`${products.adds_glow} — booster de hidratación y luminosidad`); }

  // noche
  if(night === 'overnight'){ rutina.push(`${products.overnight_repair} — activos más potentes por la noche (introducir gradualmente)`); }
  else { rutina.push(`${products.skin_perfection} — reparación nocturna suave`); }

  // objetivos extras
  if(objs.includes('glow')) rutina.push(`${products.adds_glow} — booster 1–3x/sem`);
  if(objs.includes('effect')) rutina.push(`${products.adds_effect}`);
  if(objs.includes('repair')) rutina.push(`${products.adds_repair}`);
  if(objs.includes('eye')) rutina.push(`${products.eye_serum}`);

  // consejos prácticos
  const practical = [];
  practical.push('Protector solar SPF30+ diario (indispensable).');
  if(q2>=1) practical.push('Evitar exposiciones largas al sol sin protección.');
  if(q11===1) practical.push('Aportar hidratación extra en ambientes con climatización.');
  if(reactive) practical.push('Introducir activos lentamente; hacer patch-test.');

  // -------------------- Supplement logic (máx 3) --------------------
  const suples = [];
  function pushS(s){
    if(!s) return;
    if(suples.indexOf(s) === -1 && suples.length < 3) suples.push(s);
  }
  // Base by type
  if(tipoBase === 'Piel Grasa') pushS('CAPS Skin'); // equilibrio microbioma
  if(tipoBase === 'Piel Mixta') pushS('CAPS Antiox');
  if(tipoBase === 'Piel Seca') pushS('CAPS Hyaluron');

  if(reactive) pushS('CAPS Protect');
  if(prio === 'antiage' || isMature) pushS('CAPS Omega 3');
  if(q2>=1 || q8===1) pushS('CAPS Antiox'); // sol/ciudad
  if(q11===1) pushS('CAPS Hyaluron');
  if(q12>=1 || q5>=1) pushS('PACK Cleansing');
  if(q13>=1) pushS('CAPS Omega 3');
  if(q9===2) pushS('PACK Energy');

  if(suples.length === 0) pushS('CAPS Antiox');

  const suplDesc = {
    "CAPS Skin":"Apoya el equilibrio del microbioma y regula impurezas.",
    "CAPS Hyaluron":"Hialurónico oral para hidratación interna y elasticidad.",
    "CAPS Protect":"Refuerza barrera cutánea y reduce sensibilidad.",
    "CAPS Antiox":"Antioxidantes para proteger frente a sol y contaminación.",
    "CAPS Omega 3":"Ácidos grasos para inflamación, hidratación y circulación.",
    "PACK Cleansing":"Pack detox para apoyar función hepática y piel apagada.",
    "PACK Energy":"Soporte energético y vitalidad (piel cansada)."
  };

  // -------------------- Build output HTML --------------------
  const diagHtml = `<div class="result-card">
    <h3>Tipo base: ${escapeHtml(tipoBase)}</h3>
    <div class="muted">${subtypeNotes.length?escapeHtml(subtypeNotes.join(' • ')) : 'Sin subtipo detectado'}</div>
    <p style="margin-top:8px"><strong>Puntuación (base):</strong> ${total} puntos</p>
  </div>`;

  const routineHtml = `<div style="margin-top:12px"><strong>Rutina recomendada (resumen):</strong>
    <ul>${rutina.map(r=>`<li>${escapeHtml(r)}</li>`).join('')}</ul>
    <div style="margin-top:8px"><strong>Consejos prácticos:</strong><ul>${practical.map(p=>`<li>${escapeHtml(p)}</li>`).join('')}</ul></div>
  </div>`;

  const suplHtml = `<div style="margin-top:12px"><strong>Suplementación sugerida (máx 3):</strong>
    <ul>${suples.map(s=>`<li><strong>${escapeHtml(s)}</strong> — ${escapeHtml(suplDesc[s]||'')}</li>`).join('')}</ul></div>`;

  const expectHtml = `<div style="margin-top:12px"><strong>¿Qué esperar en 30 días?</strong>
    <ul>
      <li>Mejoría en hidratación y textura si se sigue la rutina constante.</li>
      <li>Disminución de brillos y poros dilatados en 4–8 semanas con exfoliación suave.</li>
      <li>Reducción de rojeces con productos calmantes en 2–6 semanas.</li>
    </ul>
  </div>`;

  // render
  document.getElementById('diagnosis').innerHTML = diagHtml;
  document.getElementById('routine').innerHTML = routineHtml;
  document.getElementById('supplements').innerHTML = suplHtml;
  document.getElementById('whatToExpect').innerHTML = expectHtml;

  // share links
  const nameForMail = encodeURIComponent((document.getElementById('q18').value || '').trim() || 'Cliente Ringana');
  const subject = encodeURIComponent('Mi diagnóstico de piel · BiancaBloomRingana');
  const bodyTxt = encodeURIComponent(`Diagnóstico: ${tipoBase}\nSubtipos: ${subtypeNotes.join(', ') || 'N/A'}\nRutina: ${rutina.join(' | ')}\nSuplementación: ${suples.join(', ')}`);
  document.getElementById('mailto').href = `mailto:?subject=${subject}&body=${bodyTxt}`;
  document.getElementById('wa').href = `https://wa.me/?text=${encodeURIComponent('Mi diagnóstico Ringana: '+tipoBase+'. Revisa por favor.')}`;

  document.getElementById('resultPanel').hidden = false;
  document.getElementById('shareWrap').style.display = 'flex';

  // store snapshot for PDF
  window._lastResult = { tipoBase, subtypeNotes, total, rutina, practical, suples, suplDesc, uploadedPhotoData };
  document.getElementById('resultPanel').scrollIntoView({behavior:'smooth'});
}

/* -------------------- Utilities -------------------- */
function resetForm(){
  for(let i=1;i<=23;i++){
    const e = document.getElementById('q'+i);
    if(e && e.tagName==='SELECT') e.selectedIndex = 0;
    if(e && e.tagName==='INPUT') e.value = '';
  }
  const checks = document.querySelectorAll('.obj');
  checks.forEach(c=>c.checked=false);
  document.getElementById('resultPanel').hidden = true;
  document.getElementById('shareWrap').style.display = 'none';
  localStorage.removeItem('ringana_registered');
  uploadedPhotoData = null;
  if(fotoPreview) { fotoPreview.style.display='none'; fotoPreview.src=''; }
}

/* -------------------- PDF generation (professional) -------------------- */
function downloadPDF(){
  const r = window._lastResult;
  if(!r) return alert('Genera primero el resultado.');

  // build html for print
  const photoSection = r.uploadedPhotoData ? `<div style="margin-top:12px"><strong>Foto (opcional):</strong><div><img src="${r.uploadedPhotoData}" style="max-width:320px;border-radius:8px;border:1px solid #e6efe6;margin-top:8px" /></div></div>` : '';
  const rutinaHtml = r.rutina.map(x=>`<li>${escapeHtml(x)}</li>`).join('');
  const suplHtml = r.suples.map(s=>`<li><strong>${escapeHtml(s)}</strong> — ${escapeHtml(r.suplDesc[s]||'')}</li>`).join('');
  const subtypeTxt = r.subtypeNotes.length ? escapeHtml(r.subtypeNotes.join(' • ')) : 'Sin subtipo detectado';

  const html = `
  <html><head><meta charset="utf-8"/><title>Informe · ${escapeHtml(r.tipoBase)}</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#223}
    h1{color:${getComputedStyle(document.documentElement).getPropertyValue('--accent-dark')||'#264'};text-align:center}
    .box{border-radius:10px;padding:16px;background:#fbfffb;border:1px solid #eef6ee;margin-top:12px}
    ul{line-height:1.4}
    .muted{color:#66786e;font-size:13px}
  </style>
  </head><body>
    <h1>Informe de Piel · BiancaBloomRingana</h1>
    <p class="muted" style="text-align:center">Ética y excelencia: el cóctel infalible.</p>

    <div class="box">
      <p><strong>Tipo:</strong> ${escapeHtml(r.tipoBase)}</p>
      <p class="muted">${subtypeTxt}</p>
      <p><strong>Puntuación base:</strong> ${r.total}</p>

      <h3>Rutina recomendada</h3>
      <ul>${rutinaHtml}</ul>

      <h3>Suplementación sugerida (máx 3)</h3>
      <ul>${suplHtml}</ul>

      ${photoSection}

      <h3>¿Qué esperar en 30 días?</h3>
      <ul>
        <li>Mejoría en hidratación y textura con cumplimiento diario.</li>
        <li>Reducción de poros y brillos con exfoliación semanal suave.</li>
        <li>Menos rojeces con activos calmantes y evitar irritantes.</li>
      </ul>

      <p class="muted">Nota: recomendaciones orientativas. Consulta en embarazo, lactancia o medicación.</p>
    </div>

    <script>window.print()</script>
  </body></html>`;

  const popup = window.open('', '_blank','width=900,height=900');
  popup.document.open();
  popup.document.write(html);
  popup.document.close();
}

/* -------------------- Expose for debug / helpers -------------------- */
window.runTest = runTest;
window.resetForm = resetForm;
window.simulateAccess = simulateAccess;
window.downloadPDF = downloadPDF;

/* quick utilities */
function copyRegisterLink(){
  try{
    navigator.clipboard.writeText(document.getElementById('registerLink').value);
    alert('Enlace copiado al portapapeles');
  }catch(e){ prompt('Copia tu enlace', document.getElementById('registerLink').value); }
}

</script>
</body>
</html>
